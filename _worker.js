// <!--GAMFC-->version base on commit: 47d47461b90d74a158f579063afb1216554466ff - last update: 2025-11-18 20:21:22 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','adminPasswordHash':'8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a918','scamalytics':{'username':'','apiKey':'','baseUrl':'https://api12.scamalytics.com/v3/'},async 'fromEnv'(a){let b=null,c=null,d=0x1bb;if(a['D1'])try{const {results:g}=await a['D1']['prepare']('SELECT\x20ip_port\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x201')['all']();b=g[0x0]?.['ip_port']||null;}catch(h){console['error']('D1\x20Smart\x20Selection\x20Failed:\x20'+h['message']);}if(!b&&a['PROXY_IPS']){const i=a['PROXY_IPS']['split'](',')['map'](j=>j['trim']())['filter'](j=>j['length']>0x0);b=i[Math['floor'](Math['random']()*i['length'])];}if(!b)throw new Error('PROXY_IPS\x20is\x20not\x20set\x20and\x20no\x20healthy\x20IP\x20found\x20in\x20D1.');[c,d='443']=b['split'](':'),d=parseInt(d,0xa);let f=c;if(a['HOST_HEADERS']){const j=a['HOST_HEADERS']['split'](',')['map'](k=>k['trim']())['filter'](k=>k['length']>0x0);f=j[Math['floor'](Math['random']()*j['length'])];}else f=c;return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':d,'proxyAddress':b,'adminPasswordHash':a['ADMIN_PASSWORD']?await hashSHA256(a['ADMIN_PASSWORD']):this['adminPasswordHash'],'hostHeader':f,'allProxyIPs':a['PROXY_IPS']?a['PROXY_IPS']['split'](',')['map'](k=>k['trim']())['filter'](k=>k['length']>0x0):[b],'scamalytics':this['scamalytics']};}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2,'ADMIN_LOGIN_FAIL_LIMIT':0x5,'ADMIN_LOGIN_LOCK_TTL':0x258,'SCAMALYTICS_THRESHOLD':0x32,'USER_PATH_RATE_LIMIT':0x14,'USER_PATH_RATE_TTL':0x3c,'AUTO_REFRESH_INTERVAL':0xea60,'IP_CLEANUP_AGE_DAYS':0x1e};async function kvGet(a,b,c='text'){try{const d=a['prepare']('SELECT\x20value,\x20expiration\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b),f=await d['first']();if(!f)return null;if(f['expiration']&&f['expiration']<Math['floor'](Date['now']()/0x3e8))return await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run'](),null;if(c==='json')try{return JSON['parse'](f['value']);}catch(g){return null;}return f['value'];}catch(h){return null;}}async function kvPut(a,b,c,d={}){try{if(typeof c==='object')c=JSON['stringify'](c);const f=d['expirationTtl']?Math['floor'](Date['now']()/0x3e8+d['expirationTtl']):null;await a['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20key_value\x20(key,\x20value,\x20expiration)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](b,c,f)['run']();}catch(g){console['error']('KV\x20Put\x20Error:',g['message']);}}async function kvDelete(a,b){try{await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run']();}catch(c){}}async function getUserData(a,b,c){if(!isValidUUID(b)||!a['D1'])return null;const d='user:'+b,e=await kvGet(a['D1'],d,'json');if(e&&e['uuid'])return e;const f=await a['D1']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!f)return null;const g=kvPut(a['D1'],d,f,{'expirationTtl':0xe10});if(c)c['waitUntil'](g);return f;}async function updateUsage(a,b,c,d){if(c<=0x0||!b||!a['D1'])return;const e='usage_lock:'+b;let f=![];try{const g=await kvGet(a['D1'],e);if(!g)await kvPut(a['D1'],e,'locked',{'expirationTtl':0x5}),f=!![];else return;const h=Math['round'](c),i=a['D1']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](h,b)['run'](),j=kvDelete(a['D1'],'user:'+b);if(d)d['waitUntil'](Promise['all']([i,j]));}catch(k){console['error']('Usage\x20update\x20error:',k['message']);}finally{if(f)d['waitUntil'](kvDelete(a['D1'],e));}}async function runHealthCheck(a,b,c){const d=c['map'](g=>checkProxyHealth(g,a['D1'],b)),e=await Promise['all'](d),f=e['filter'](g=>g['is_healthy'])['length'];return{'message':'Health\x20check\x20completed\x20for\x20'+c['length']+'\x20IPs.\x20'+f+'\x20are\x20healthy.','results':e};}async function checkProxyHealth(a,b,c){const d=Date['now']();let f=0x0,g=0x270f;const [h,i='443']=a['split'](':'),j=parseInt(i,0xa);try{const k=connect({'hostname':h,'port':j,'secureTransport':'on'}),l=new Promise(m=>{k['closed']['catch'](()=>{}),k['closed']['finally'](()=>m(![])),setTimeout(()=>m(!![]),0xc8);});await l?(f=0x1,g=Date['now']()-d):g=Date['now']()-d,k['close']()['catch'](()=>{});}catch(m){f=0x0;}finally{const n=b['prepare']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20INSERT\x20OR\x20REPLACE\x20INTO\x20proxy_health\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(ip_port,\x20is_healthy,\x20latency_ms,\x20last_check)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x20?,\x20?,\x20strftime(\x27%s\x27,\x20\x27now\x27))\x0a\x20\x20\x20\x20\x20\x20\x20\x20')['bind'](a,f,g)['run']();c['waitUntil'](n);}return{'ip_port':a,'is_healthy':f,'latency_ms':g};}const adminPanelHTML=(a,b,c=[])=>'\x0a<!doctype\x20html>\x0a<style\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>/*\x20...\x20styles\x20...\x20*/</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20<h1>üéõÔ∏è\x20VLESS\x20Admin\x20Panel</h1>\x0a\x20\x20\x20\x20\x20\x20<div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20success-btn\x22\x20onclick=\x22openModal(\x27add\x27)\x22>‚ûï\x20Add\x20User</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22/'+a+'/logout\x22\x20class=\x22btn\x20danger-btn\x22>üö™\x20Logout</a>\x0a\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<h3>ü©∫\x20Proxy\x20Health\x20Status</h3>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x22\x20id=\x22run-check-btn\x22\x20onclick=\x22runHealthCheck()\x22>Run\x20Health\x20Check\x20Now</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<table\x20class=\x22user-table\x22\x20style=\x22margin-top:15px\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<thead>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<tr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th>Proxy\x20Address</th>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th>Status</th>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th>Latency\x20(ms)</th>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th>Last\x20Check</th>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</tr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</thead>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<tbody>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+c['map'](d=>'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<tr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20style=\x22font-family:monospace\x22>'+d['ip_port']+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22'+(d['is_healthy']?'status-active':'status-expired')+'\x22>'+(d['is_healthy']?'HEALTHY':'DOWN')+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>'+d['latency_ms']+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>'+(d['last_check']?new Date(d['last_check']*0x3e8)['toLocaleString']():'N/A')+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</tr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20')['join']('')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</tbody>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</table>\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+(c['length']===0x0?'<p\x20style=\x22text-align:center;color:var(--muted);padding:20px;\x22>No\x20health\x20data.\x20Run\x20a\x20check\x20first.</p>':'')+'\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h3>üë•\x20User\x20Management</h3>\x0a\x20\x20\x20\x20\x20\x20<table\x20class=\x22user-table\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</table>\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20</div>\x0a\x0a\x20\x20<script\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20//\x20...\x20(Javascript\x20functions\x20like\x20formatBytes,\x20copyText,\x20openModal,\x20closeModal,\x20deleteUser\x20-\x20UNCHANGED)\x20...\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20async\x20function\x20runHealthCheck()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27run-check-btn\x27).innerText\x20=\x20\x27Running...\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27run-check-btn\x27).disabled\x20=\x20true;\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20response\x20=\x20await\x20fetch(\x27/'+a+'/api/healthcheck\x27,\x20{\x20method:\x20\x27POST\x27\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(response.ok)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20alert(\x27Health\x20check\x20initiated.\x20Refresh\x20the\x20page\x20in\x2030\x20seconds.\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x20else\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20alert(\x27Failed\x20to\x20initiate\x20health\x20check.\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27run-check-btn\x27).innerText\x20=\x20\x27Run\x20Health\x20Check\x20Now\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27run-check-btn\x27).disabled\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20window.location.reload();\x0a\x20\x20\x20\x20}\x0a\x20\x20</script>\x0a</body>\x0a</html>\x0a';async function getHealthStatus(a){if(!a['D1'])return[];try{const {results:b}=await a['D1']['prepare']('SELECT\x20*\x20FROM\x20proxy_health\x20ORDER\x20BY\x20is_healthy\x20DESC,\x20latency_ms\x20ASC')['all']();return b;}catch(c){return console['error']('Failed\x20to\x20fetch\x20health\x20status:',c['message']),[];}}async function handleAdminRequest(a,b,c,d,e){const f=await checkAdminAuth(a,b,d,e),g=new URL(a['url']);if(g['pathname']==='/'+e+'/api/healthcheck'){if(!f)return new Response('Unauthorized',{'status':0x191});if(a['method']!=='POST')return new Response('Method\x20Not\x20Allowed',{'status':0x195});const {message:h}=await runHealthCheck(b,c,d['allProxyIPs']);return new Response(JSON['stringify']({'message':h}),{'headers':{'Content-Type':'application/json'}});}if(g['pathname']==='/'+e+'/'){if(!f)return handleAdminLogin(e);const i=await b['D1']['prepare']('SELECT\x20*\x20FROM\x20users')['all']()['then'](m=>m['results']||[]),j=await getHealthStatus(b),k=generateNonce(),l=new Headers({'Content-Type':'text/html;charset=utf-8'});return addSecurityHeaders(l,k),new Response(adminPanelHTML(e,i,j)['replace'](/CSP_NONCE_PLACEHOLDER/g,k),{'headers':l});}return new Response('Not\x20Found',{'status':0x194});}async function ProtocolOverWSHandler(a,b,c,d){return await handleTCP(remoteSocketWrapper,addressType,addressRemote,portRemote,rawClientData,webSocket,vlessResponseHeader,log,b),new Response(null,{'status':0x65,'webSocket':client});}async function handleTCP(a,b,c,d,e,f,g,h,i){const j={'hostname':i['proxyIP'],'port':i['proxyPort'],'allowHalfOpen':!![],'host':i['hostHeader'],'secureTransport':'on'},k=connect(j);a['value']=k;const l=k['writable']['getWriter']();await l['write'](e),l['releaseLock'](),await k['readable']['pipeTo'](new WritableStream({async 'write'(m){if(f['readyState']===0x1){const n=g?await new Blob([g,m])['arrayBuffer']():m;f['send'](n),g=null;}}}));}export default{async 'scheduled'(a,b,c){if(!b['D1']||!b['PROXY_IPS']){console['log']('D1\x20or\x20PROXY_IPS\x20not\x20configured\x20for\x20scheduled\x20health\x20check.');return;}const d=b['PROXY_IPS']['split'](',')['map'](e=>e['trim']())['filter'](e=>e['length']>0x0);if(d['length']===0x0)return;await runHealthCheck(b,c,d);},async 'fetch'(a,b,c){let d;try{d=await Config['fromEnv'](b);}catch(f){return new Response('Configuration\x20Error:\x20'+f['message'],{'status':0x1f4});}const e=new URL(a['url']);if(a['headers']['get']('Upgrade')==='websocket')return ProtocolOverWSHandler(a,d,b,c);return new Response('Not\x20Found',{'status':0x194});}};