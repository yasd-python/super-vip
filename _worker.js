// <!--GAMFC-->version base on commit: c6d56774f43d4de1467a0d88503ddad1f2e7742d - last update: 2025-11-18 17:49:44 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','proxyIPs':['nima.nscl.ir:443','bpb.yousef.isegaro.com:443'],'adminPasswordHash':'8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918','adminTOTPSecret':'','scamalytics':{'username':'','apiKey':'','baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':![],'relayMode':![],'address':''},async 'fromEnv'(a){let b=null;if(a['D1'])try{const {results:f}=await a['D1']['prepare']('SELECT\x20ip\x20FROM\x20proxy_scans\x20WHERE\x20is_current_best\x20=\x201\x20LIMIT\x201')['all']();b=f[0x0]?.['ip']||null;}catch(g){console['error']('Failed\x20to\x20read\x20from\x20D1:\x20'+g['message']);}!b&&(b=a['PROXYIP']);!b&&(b=this['proxyIPs'][Math['floor'](Math['random']()*this['proxyIPs']['length'])]);!b&&(b=this['proxyIPs'][0x0]);const [c,d='443']=b['split'](':');return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':parseInt(d,0xa),'proxyAddress':b,'adminPasswordHash':a['ADMIN_PASSWORD']?await hashSHA256(a['ADMIN_PASSWORD']):this['adminPasswordHash'],'adminTOTPSecret':a['ADMIN_TOTP_SECRET']||this['adminTOTPSecret'],'scamalytics':{'username':a['SCAMALYTICS_USERNAME']||this['scamalytics']['username'],'apiKey':a['SCAMALYTICS_API_KEY']||this['scamalytics']['apiKey'],'baseUrl':a['SCAMALYTICS_BASEURL']||this['scamalytics']['baseUrl']},'socks5':{'enabled':!!a['SOCKS5'],'relayMode':a['SOCKS5_RELAY']==='true'||this['socks5']['relayMode'],'address':a['SOCKS5']||this['socks5']['address']}};}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2,'ADMIN_LOGIN_FAIL_LIMIT':0x5,'ADMIN_LOGIN_LOCK_TTL':0x258,'SCAMALYTICS_THRESHOLD':0x32,'USER_PATH_RATE_LIMIT':0x14,'USER_PATH_RATE_TTL':0x3c,'AUTO_REFRESH_INTERVAL':0xea60,'IP_CLEANUP_AGE_DAYS':0x1e};function generateNonce(){const a=new Uint8Array(0x10);return crypto['getRandomValues'](a),btoa(String['fromCharCode']['apply'](null,a));}function addSecurityHeaders(a,b,c={}){const d=['default-src\x20\x27self\x27','form-action\x20\x27self\x27','object-src\x20\x27none\x27','frame-ancestors\x20\x27none\x27','base-uri\x20\x27self\x27',b?'script-src\x20\x27nonce-'+b+'\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com\x20\x27unsafe-inline\x27':'script-src\x20\x27self\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com\x20\x27unsafe-inline\x27','style-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-hashes\x27\x20https://fonts.googleapis.com\x20https://cdnjs.cloudflare.com',('img-src\x20\x27self\x27\x20data:\x20https:\x20blob:\x20'+(c['img']||''))['trim'](),('connect-src\x20\x27self\x27\x20https:\x20'+(c['connect']||''))['trim'](),'font-src\x20\x27self\x27\x20https://fonts.gstatic.com\x20https://cdnjs.cloudflare.com'];a['set']('Content-Security-Policy',d['join'](';\x20')),a['set']('Strict-Transport-Security','max-age=63072000;\x20includeSubDomains;\x20preload'),a['set']('X-Content-Type-Options','nosniff'),a['set']('X-Frame-Options','SAMEORIGIN'),a['set']('Referrer-Policy','strict-origin-when-cross-origin'),a['set']('Permissions-Policy','camera=(),\x20microphone=(),\x20geolocation=(),\x20payment=(),\x20usb=()'),a['set']('Cross-Origin-Opener-Policy','same-origin'),a['set']('Cross-Origin-Resource-Policy','same-origin');}function timingSafeEqual(c,d){if(typeof c!=='string'||typeof d!=='string')return![];const e=c['length'],f=d['length'];let g=0x0;if(e!==f){for(let h=0x0;h<e;h++)g|=c['charCodeAt'](h)^c['charCodeAt'](h);return![];}for(let j=0x0;j<e;j++)g|=c['charCodeAt'](j)^d['charCodeAt'](j);return g===0x0;}function escapeHTML(a){if(typeof a!=='string')return'';return a['replace'](/[&<>"']/g,b=>({'&':'&amp;','<':'&lt;','>':'&gt;','\x22':'&quot;','\x27':'&#39;'}[b]));}function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isExpired(a,b){if(!a||!b)return![];const c=b['includes'](':')&&b['split'](':')['length']===0x2?b+':00':b,d=c['split']('.')[0x0],e=new Date(a+'T'+d+'Z');return e<=new Date()||isNaN(e['getTime']());}function formatBytes(a){if(a===0x0)return'0\x20Bytes';const b=0x400,c=['Bytes','KB','MB','GB','TB'],d=Math['floor'](Math['log'](a)/Math['log'](b));return parseFloat((a/Math['pow'](b,d))['toFixed'](0x2))+'\x20'+c[d];}async function hashSHA256(a){const b=await crypto['subtle']['digest']('SHA-256',new TextEncoder()['encode'](a));return Array['from'](new Uint8Array(b))['map'](c=>c['toString'](0x10)['padStart'](0x2,'0'))['join']('');}async function kvGet(a,b,c='text'){try{const d=a['prepare']('SELECT\x20value,\x20expiration\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b),f=await d['first']();if(!f)return null;if(f['expiration']&&f['expiration']<Math['floor'](Date['now']()/0x3e8))return await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run'](),null;if(c==='json')try{return JSON['parse'](f['value']);}catch(g){return null;}return f['value'];}catch(h){return null;}}async function kvPut(a,b,c,d={}){try{if(typeof c==='object')c=JSON['stringify'](c);const f=d['expirationTtl']?Math['floor'](Date['now']()/0x3e8+d['expirationTtl']):null;await a['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20key_value\x20(key,\x20value,\x20expiration)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](b,c,f)['run']();}catch(g){}}async function kvDelete(a,b){try{await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run']();}catch(c){}}async function getUserData(a,b,c){if(!isValidUUID(b))return null;if(!a['DB'])return null;const d='user:'+b;try{const h=await kvGet(a['DB'],d,'json');if(h&&h['uuid'])return h;}catch(i){}const f=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!f)return null;const g=kvPut(a['DB'],d,f,{'expirationTtl':0xe10});if(c)c['waitUntil'](g);return f;}async function updateUsage(a,b,c,d){if(c<=0x0||!b)return;const e='usage_lock:'+b;let f=![];try{while(!f){const j=await kvGet(a['DB'],e);!j?(await kvPut(a['DB'],e,'locked',{'expirationTtl':0x5}),f=!![]):await new Promise(k=>setTimeout(k,0x64));}const g=Math['round'](c),h=a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](g,b)['run'](),i=kvDelete(a['DB'],'user:'+b);if(d)d['waitUntil'](Promise['all']([h,i]));}catch(k){}finally{if(f)await kvDelete(a['DB'],e);}}function base32ToBuffer(a){const b='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567',c=a['toUpperCase']()['replace'](/=+$/,'');let d=0x0,e=0x0,f=0x0;const g=new Uint8Array(Math['floor'](c['length']*0x5/0x8));for(let h=0x0;h<c['length'];h++){const j=b['indexOf'](c[h]);if(j===-0x1)throw new Error('Invalid\x20Base32\x20character');e=e<<0x5|j,d+=0x5,d>=0x8&&(g[f++]=e>>>d-0x8&0xff,d-=0x8);}return g['buffer'];}async function generateHOTP(a,b){const c=new ArrayBuffer(0x8),d=new DataView(c);d['setBigUint64'](0x0,BigInt(b),![]);const e=await crypto['subtle']['importKey']('raw',a,{'name':'HMAC','hash':'SHA-1'},![],['sign']),f=await crypto['subtle']['sign']('HMAC',e,c),g=new Uint8Array(f),h=g[g['length']-0x1]&0xf,i=(g[h]&0x7f)<<0x18|(g[h+0x1]&0xff)<<0x10|(g[h+0x2]&0xff)<<0x8|g[h+0x3]&0xff;return(i%0xf4240)['toString']()['padStart'](0x6,'0');}async function validateTOTP(a,b){if(!a||!b||b['length']!==0x6)return![];try{const c=base32ToBuffer(a),d=0x1e,f=Math['floor'](Date['now']()/0x3e8),g=Math['floor'](f/d);for(const h of[g,g-0x1,g+0x1]){if(timingSafeEqual(b,await generateHOTP(c,h)))return!![];}}catch(i){return![];}return![];}const byteToHex=Array['from']({'length':0x100},(a,b)=>(b+0x100)['toString'](0x10)['slice'](0x1));function stringify(a,b=0x0){const c=(byteToHex[a[b]]+byteToHex[a[b+0x1]]+byteToHex[a[b+0x2]]+byteToHex[a[b+0x3]]+'-'+byteToHex[a[b+0x4]]+byteToHex[a[b+0x5]]+'-'+byteToHex[a[b+0x6]]+byteToHex[a[b+0x7]]+'-'+byteToHex[a[b+0x8]]+byteToHex[a[b+0x9]]+'-'+byteToHex[a[b+0xa]]+byteToHex[a[b+0xb]]+byteToHex[a[b+0xc]]+byteToHex[a[b+0xd]]+byteToHex[a[b+0xe]]+byteToHex[a[b+0xf]])['toLowerCase']();if(!isValidUUID(c))throw new TypeError('Stringified\x20UUID\x20is\x20invalid');return c;}function generateRandomPath(a=0xc,b=''){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let d='';for(let e=0x0;e<a;e++)d+=c['charAt'](Math['floor'](Math['random']()*c['length']));return'/'+d+(b?'?'+b:'');}const CORE_PRESETS={'xray':{'tls':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':{}},'tcp':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'none','fp':'chrome','extra':{}}},'sb':{'tls':{'path':()=>generateRandomPath(0x12),'security':'tls','fp':'firefox','alpn':'h3','extra':CONST['ED_PARAMS']},'tcp':{'path':()=>generateRandomPath(0x12),'security':'none','fp':'firefox','extra':CONST['ED_PARAMS']}}};function buildLink({core:a,proto:b,userID:c,hostName:d,address:e,port:f,tag:g}){const h=CORE_PRESETS[a][b],i=new URLSearchParams({'type':'ws','host':d,'path':h['path']()});if(h['security'])i['set']('security',h['security']);if(h['security']==='tls')i['set']('sni',d);if(h['fp'])i['set']('fp',h['fp']);if(h['alpn'])i['set']('alpn',h['alpn']);for(const [j,l]of Object['entries'](h['extra']))i['set'](j,l);return'vless://'+c+'@'+e+':'+f+'?'+i['toString']()+'#'+encodeURIComponent(g+'-'+b['toUpperCase']());}async function handleIpSubscription(a,b,c){const d=[],f=[0x1bb,0x805,0x823,0x827,0x830,0x20fb],g=i=>i[Math['floor'](Math['random']()*i['length'])];d['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':c,'port':0x1bb,'tag':'Main'}));try{const i=await fetch('https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json');if(i['ok']){const j=await i['json'](),k=[...j['ipv4']??[],...j['ipv6']??[]]['slice'](0x0,0x14)['map'](l=>l['ip']);k['forEach']((l,m)=>{const n=l['includes'](':')?'['+l+']':l;d['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':n,'port':g(f),'tag':'CF-IP'+(m+0x1)}));});}}catch(l){}const h=new Headers({'Content-Type':'text/plain;charset=utf-8'});return addSecurityHeaders(h,null),new Response(btoa(d['join']('\x0a')),{'headers':h});}const adminLoginHTML='<!DOCTYPE\x20html><html\x20lang=\x22en\x22><head><meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22><title>Admin\x20Login</title><style\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background-color:#121212;font-family:system-ui,sans-serif;color:#fff}.login-container{background:#1e1e1e;padding:40px;border-radius:12px;width:320px;border:1px\x20solid\x20#333;text-align:center}input{background:#2c2c2c;border:1px\x20solid\x20#444;color:#fff;padding:12px;border-radius:8px;margin-bottom:20px;width:100%;box-sizing:border-box}button{background:#007aff;color:#fff;border:none;padding:12px;border-radius:8px;width:100%;cursor:pointer;font-weight:600}</style></head><body><div\x20class=\x22login-container\x22><h1>Admin\x20Login</h1><form\x20method=\x22POST\x22\x20action=\x22ADMIN_PATH_PLACEHOLDER\x22><input\x20type=\x22password\x22\x20name=\x22password\x22\x20placeholder=\x22Password\x22\x20required><input\x20type=\x22text\x22\x20name=\x22totp\x22\x20placeholder=\x22TOTP\x20Code\x20(Optional)\x22\x20><button\x20type=\x22submit\x22>Login</button></form></div></body></html>',adminPanelHTML=(a,b)=>'\x0a<!doctype\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22utf-8\x22\x20/>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22\x20/>\x0a\x20\x20<title>Admin\x20Panel</title>\x0a\x20\x20<style\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20:root{--bg:#0b1220;--card:#0f1724;--muted:#9aa4b2;--accent:#3b82f6;--success:#22c55e;--danger:#ef4444;--radius:12px}\x0a\x20\x20\x20\x20*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:#e6eef8;padding:20px;min-height:100vh}\x0a\x20\x20\x20\x20.container{max-width:1200px;margin:0\x20auto}.card{background:var(--card);border-radius:var(--radius);padding:20px;border:1px\x20solid\x20rgba(255,255,255,0.05);margin-bottom:20px;box-shadow:0\x204px\x2020px\x20rgba(0,0,0,0.3)}\x0a\x20\x20\x20\x20h1{font-size:24px;margin:0\x200\x2010px}.header{display:flex;justify-content:space-between;align-items:center}\x0a\x20\x20\x20\x20.btn{display:inline-flex;padding:10px\x2016px;border-radius:6px;background:var(--accent);color:#fff;text-decoration:none;border:none;cursor:pointer;font-weight:600;font-size:14px;align-items:center}\x0a\x20\x20\x20\x20.btn:hover{opacity:0.9}.danger-btn{background:var(--danger)}.success-btn{background:var(--success)}\x0a\x20\x20\x20\x20.user-table{width:100%;border-collapse:separate;border-spacing:0\x2010px}\x0a\x20\x20\x20\x20.user-table\x20th,.user-table\x20td{padding:15px;text-align:left;font-size:14px}\x0a\x20\x20\x20\x20.user-table\x20thead\x20th{background:#1a2639;border-radius:8px\x208px\x200\x200;font-weight:600;color:#fff}\x0a\x20\x20\x20\x20.user-table\x20tbody\x20td{background:#1a2639;border-bottom:1px\x20solid\x20rgba(255,255,255,0.05)}\x0a\x20\x20\x20\x20.user-table\x20tr:hover\x20td{background:#2a3649}\x0a\x20\x20\x20\x20.form-group{margin-bottom:15px}\x0a\x20\x20\x20\x20.form-group\x20label{display:block;margin-bottom:5px;font-size:14px}\x0a\x20\x20\x20\x20.form-group\x20input{width:100%;padding:10px;background:#2c2c2c;border:1px\x20solid\x20#444;color:#fff;border-radius:6px;box-sizing:border-box}\x0a\x20\x20\x20\x20.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:100;opacity:0;pointer-events:none;transition:opacity\x200.3s}\x0a\x20\x20\x20\x20.modal-overlay.open{opacity:1;pointer-events:auto}\x0a\x20\x20\x20\x20.modal-content{background:var(--card);padding:30px;border-radius:var(--radius);width:90%;max-width:500px;position:relative}\x0a\x20\x20\x20\x20.modal-content\x20h2{margin-top:0}\x0a\x20\x20\x20\x20.status-active{color:var(--success)}.status-expired{color:var(--danger)}\x0a\x20\x20\x20\x20.uuid-abbr{font-family:monospace;cursor:pointer}\x0a\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<div\x20class=\x22header\x22>\x0a\x20\x20\x20\x20\x20\x20<h1>üéõÔ∏è\x20VLESS\x20Admin\x20Panel</h1>\x0a\x20\x20\x20\x20\x20\x20<div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20success-btn\x22\x20onclick=\x22openModal(\x27add\x27)\x22>‚ûï\x20Add\x20User</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<a\x20href=\x22/'+a+'/logout\x22\x20class=\x22btn\x20danger-btn\x22>üö™\x20Logout</a>\x0a\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<table\x20class=\x22user-table\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<thead>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<tr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th>UUID</th>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th>Limit\x20/\x20Used</th>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th>Expiry</th>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th>Status</th>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th>Actions</th>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</tr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</thead>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<tbody>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+b['map'](c=>'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<tr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td><span\x20class=\x22uuid-abbr\x22\x20onclick=\x22copyText(\x27'+c['uuid']+'\x27)\x22>'+c['uuid']['substring'](0x0,0x8)+'...</span></td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>'+formatBytes(c['traffic_limit'])+'\x20/\x20'+formatBytes(c['traffic_used'])+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>'+(c['expiration_date']||'N/A')+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22'+(isExpired(c['expiration_date'],c['expiration_time'])?'status-expired':'status-active')+'\x22>'+(isExpired(c['expiration_date'],c['expiration_time'])?'Expired':'Active')+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x22\x20onclick=\x22openModal(\x27edit\x27,\x20\x27'+c['uuid']+'\x27,\x20\x27'+c['traffic_limit']+'\x27,\x20\x27'+(c['expiration_date']||'')+'\x27,\x20\x27'+(c['expiration_time']||'')+'\x27)\x22>Edit</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20danger-btn\x22\x20onclick=\x22deleteUser(\x27'+c['uuid']+'\x27)\x22>Delete</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</tr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20')['join']('')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20</tbody>\x0a\x20\x20\x20\x20\x20\x20</table>\x0a\x20\x20\x20\x20\x20\x20'+(b['length']===0x0?'<p\x20style=\x22text-align:center;color:var(--muted);padding:20px;\x22>No\x20users\x20found.</p>':'')+'\x0a\x20\x20\x20\x20</div>\x0a\x20\x20</div>\x0a\x0a\x20\x20<div\x20id=\x22userModal\x22\x20class=\x22modal-overlay\x22\x20onclick=\x22closeModal(event)\x22>\x0a\x20\x20\x20\x20<div\x20class=\x22modal-content\x22\x20onclick=\x22event.stopPropagation()\x22>\x0a\x20\x20\x20\x20\x20\x20<h2\x20id=\x22modalTitle\x22>Add\x20New\x20User</h2>\x0a\x20\x20\x20\x20\x20\x20<form\x20id=\x22userForm\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22hidden\x22\x20name=\x22uuid\x22\x20id=\x22form-uuid\x22\x20value=\x22\x22\x20/>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20for=\x22limit\x22>Traffic\x20Limit\x20(Bytes\x20/\x200\x20for\x20Unlimited)</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22number\x22\x20name=\x22limit\x22\x20id=\x22form-limit\x22\x20value=\x220\x22\x20required\x20/>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20for=\x22date\x22>Expiration\x20Date\x20(YYYY-MM-DD\x20/\x20Empty\x20for\x20Unlimited)</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22date\x22\x20name=\x22date\x22\x20id=\x22form-date\x22\x20/>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20for=\x22time\x22>Expiration\x20Time\x20(HH:MM\x20/\x20Empty\x20for\x20Unlimited)</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22time\x22\x20name=\x22time\x22\x20id=\x22form-time\x22\x20step=\x221\x22\x20/>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<button\x20type=\x22submit\x22\x20class=\x22btn\x20success-btn\x22\x20style=\x22width:100%;margin-top:20px;\x22>Save\x20User</button>\x0a\x20\x20\x20\x20\x20\x20</form>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20</div>\x0a\x0a\x20\x20<script\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20//\x20Helper\x20function\x20for\x20the\x20Admin\x20Panel\x0a\x20\x20\x20\x20function\x20formatBytes(bytes)\x20{\x0a\x20\x20\x20\x20\x20\x20if\x20(bytes\x20===\x200)\x20return\x20\x270\x20Bytes\x27;\x0a\x20\x20\x20\x20\x20\x20const\x20k\x20=\x201024;\x0a\x20\x20\x20\x20\x20\x20const\x20sizes\x20=\x20[\x27Bytes\x27,\x20\x27KB\x27,\x20\x27MB\x27,\x20\x27GB\x27,\x20\x27TB\x27];\x0a\x20\x20\x20\x20\x20\x20const\x20i\x20=\x20Math.floor(Math.log(bytes)\x20/\x20Math.log(k));\x0a\x20\x20\x20\x20\x20\x20return\x20parseFloat((bytes\x20/\x20Math.pow(k,\x20i)).toFixed(2))\x20+\x20\x27\x20\x27\x20+\x20sizes[i];\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20function\x20copyText(txt)\x20{\x0a\x20\x20\x20\x20\x20\x20navigator.clipboard.writeText(txt);\x0a\x20\x20\x20\x20\x20\x20alert(\x27Copied:\x20\x27\x20+\x20txt);\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20function\x20openModal(mode,\x20uuid\x20=\x20\x27\x27,\x20limit\x20=\x20\x270\x27,\x20date\x20=\x20\x27\x27,\x20time\x20=\x20\x27\x27)\x20{\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27modalTitle\x27).innerText\x20=\x20mode\x20===\x20\x27add\x27\x20?\x20\x27Add\x20New\x20User\x27\x20:\x20\x27Edit\x20User\x27;\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27form-uuid\x27).value\x20=\x20mode\x20===\x20\x27edit\x27\x20?\x20uuid\x20:\x20crypto.randomUUID();\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27form-limit\x27).value\x20=\x20limit\x20===\x20\x27null\x27\x20?\x20\x270\x27\x20:\x20limit;\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27form-date\x27).value\x20=\x20date;\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27form-time\x27).value\x20=\x20time;\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27userModal\x27).classList.add(\x27open\x27);\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20function\x20closeModal(event)\x20{\x0a\x20\x20\x20\x20\x20\x20if\x20(event.target.id\x20===\x20\x27userModal\x27)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27userModal\x27).classList.remove(\x27open\x27);\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20document.getElementById(\x27userForm\x27).addEventListener(\x27submit\x27,\x20async\x20function(e)\x20{\x0a\x20\x20\x20\x20\x20\x20e.preventDefault();\x0a\x20\x20\x20\x20\x20\x20const\x20uuid\x20=\x20document.getElementById(\x27form-uuid\x27).value;\x0a\x20\x20\x20\x20\x20\x20const\x20limit\x20=\x20parseInt(document.getElementById(\x27form-limit\x27).value,\x2010);\x0a\x20\x20\x20\x20\x20\x20const\x20date\x20=\x20document.getElementById(\x27form-date\x27).value;\x0a\x20\x20\x20\x20\x20\x20const\x20time\x20=\x20document.getElementById(\x27form-time\x27).value;\x0a\x0a\x20\x20\x20\x20\x20\x20const\x20data\x20=\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20uuid:\x20uuid,\x0a\x20\x20\x20\x20\x20\x20\x20\x20traffic_limit:\x20limit,\x0a\x20\x20\x20\x20\x20\x20\x20\x20expiration_date:\x20date\x20||\x20null,\x0a\x20\x20\x20\x20\x20\x20\x20\x20expiration_time:\x20time\x20?\x20time\x20+\x20\x27:00\x27\x20:\x20null,\x0a\x20\x20\x20\x20\x20\x20};\x0a\x0a\x20\x20\x20\x20\x20\x20const\x20response\x20=\x20await\x20fetch(\x27/'+a+'/api/user\x27,\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20method:\x20\x27POST\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20headers:\x20{\x20\x27Content-Type\x27:\x20\x27application/json\x27\x20},\x0a\x20\x20\x20\x20\x20\x20\x20\x20body:\x20JSON.stringify(data)\x0a\x20\x20\x20\x20\x20\x20});\x0a\x0a\x20\x20\x20\x20\x20\x20if\x20(response.ok)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20alert(\x27User\x20saved\x20successfully!\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20window.location.reload();\x0a\x20\x20\x20\x20\x20\x20}\x20else\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20alert(\x27Failed\x20to\x20save\x20user.\x20Check\x20server\x20logs.\x27);\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20});\x0a\x0a\x20\x20\x20\x20async\x20function\x20deleteUser(uuid)\x20{\x0a\x20\x20\x20\x20\x20\x20if\x20(confirm(\x27Are\x20you\x20sure\x20you\x20want\x20to\x20delete\x20user\x20\x27\x20+\x20uuid.substring(0,\x208)\x20+\x20\x27...?\x27))\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20response\x20=\x20await\x20fetch(\x27/'+a+'/api/user/\x27\x20+\x20uuid,\x20{\x20method:\x20\x27DELETE\x27\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(response.ok)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20alert(\x27User\x20deleted.\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20window.location.reload();\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x20else\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20alert(\x27Failed\x20to\x20delete\x20user.\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20}\x0a\x20\x20</script>\x0a</body>\x0a</html>\x0a';async function resolveProxyIP(a){const b=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,c=/^\[?[0-9a-fA-F:]+\]?$/;if(b['test'](a)||c['test'](a))return a;try{const e=new AbortController();setTimeout(()=>e['abort'](),0x7d0);const f=await fetch('https://1.1.1.1/dns-query?name='+a+'&type=A',{'headers':{'accept':'application/dns-json'},'signal':e['signal']}),g=await f['json']();return g['Answer']?.['find'](h=>h['type']===0x1)?.['data']||a;}catch{return a;}}async function handleUserPanel(a,b,c,f){const g='https://'+b+'/xray/'+a,h='https://'+b+'/sb/'+a,i=c['split'](':')[0x0],j=await resolveProxyIP(i);let k={'city':'Unknown','country':'Unknown'};try{const o=await fetch('https://ipapi.co/'+j+'/json/',{'headers':{'User-Agent':'Mozilla/5.0'}});if(o['ok']){const p=await o['json']();k={'city':p['city']||'Unknown','country':p['country_name']||'Unknown'};}}catch(q){}const l='\x0a<!doctype\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22utf-8\x22\x20/>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22\x20/>\x0a\x20\x20<title>User\x20Panel</title>\x0a\x20\x20<style\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20:root{--bg:#0b1220;--card:#0f1724;--muted:#9aa4b2;--accent:#3b82f6;--success:#22c55e;--danger:#ef4444;--radius:12px}\x0a\x20\x20\x20\x20*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:#e6eef8;padding:20px;min-height:100vh}\x0a\x20\x20\x20\x20.container{max-width:1000px;margin:0\x20auto}.card{background:var(--card);border-radius:var(--radius);padding:20px;border:1px\x20solid\x20rgba(255,255,255,0.05);margin-bottom:20px;box-shadow:0\x204px\x2020px\x20rgba(0,0,0,0.3)}\x0a\x20\x20\x20\x20h1{font-size:24px;margin:0\x200\x2010px}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px}\x0a\x20\x20\x20\x20.stat{padding:15px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center}\x0a\x20\x20\x20\x20.stat\x20.val{font-size:20px;font-weight:700;margin-bottom:5px}.stat\x20.lbl{font-size:12px;color:var(--muted);text-transform:uppercase}\x0a\x20\x20\x20\x20.btn{display:inline-flex;padding:10px\x2016px;border-radius:6px;background:var(--accent);color:#fff;text-decoration:none;border:none;cursor:pointer;font-weight:600;font-size:14px}\x0a\x20\x20\x20\x20.btn.ghost{background:rgba(255,255,255,0.1);margin-left:5px}.btn:hover{opacity:0.9}\x0a\x20\x20\x20\x20.grid{display:grid;grid-template-columns:1fr\x20320px;gap:20px}@media(max-width:800px){.grid{grid-template-columns:1fr}}\x0a\x20\x20\x20\x20.info-item{display:flex;justify-content:space-between;padding:10px\x200;border-bottom:1px\x20solid\x20rgba(255,255,255,0.05);font-size:14px}\x0a\x20\x20\x20\x20.info-item\x20span:first-child{color:var(--muted)}.progress-bar{height:8px;background:#1a2639;border-radius:4px;margin:10px\x200;overflow:hidden}\x0a\x20\x20\x20\x20.progress-fill{height:100%;background:var(--success);width:0%;transition:width\x200.5s}.hidden{display:none}\x0a\x20\x20\x20\x20#qr-display{display:flex;justify-content:center;align-items:center;min-height:250px;background:#fff;padding:10px;border-radius:8px;margin-top:15px}\x0a\x20\x20\x20\x20pre{background:#111;padding:10px;border-radius:6px;overflow-x:auto;font-size:12px;color:#aaa}\x0a\x20\x20\x20\x20#toast{position:fixed;top:20px;right:20px;background:#222;padding:12px\x2020px;border-radius:6px;border-left:4px\x20solid\x20var(--success);transform:translateY(-100px);transition:transform\x200.3s}\x0a\x20\x20\x20\x20#toast.show{transform:translateY(0)}\x0a\x20\x20\x20\x20.expiry-status.expired{color:var(--danger)}.expiry-status.active{color:var(--success)}\x0a\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<h1>üöÄ\x20VLESS\x20User\x20Panel</h1>\x0a\x20\x20\x20\x20<div\x20class=\x22stats\x22>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22><div\x20class=\x22val\x22\x20id=\x22status-badge\x22>Active</div><div\x20class=\x22lbl\x22>Status</div></div>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22><div\x20class=\x22val\x22\x20id=\x22usage-display\x22>0\x20B</div><div\x20class=\x22lbl\x22>Usage</div></div>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22><div\x20class=\x22val\x22>'+(f['traffic_limit']?formatBytes(f['traffic_limit']):'Unlimited')+'</div><div\x20class=\x22lbl\x22>Limit</div></div>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22><div\x20class=\x22val\x22\x20id=\x22expiry-countdown\x22>-</div><div\x20class=\x22lbl\x22>Expires\x20In</div></div>\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20'+(f['traffic_limit']?'\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20<h3>üìä\x20Data\x20Usage</h3>\x0a\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22progress-bar\x22><div\x20class=\x22progress-fill\x22\x20id=\x22p-bar\x22\x20style=\x22width:0%\x22></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22text-align:right;font-size:12px;color:var(--muted)\x22><span\x20id=\x22usage-text\x22>0</span>\x20used</div>\x0a\x20\x20\x20\x20</div>':'')+'\x0a\x0a\x20\x20\x20\x20<div\x20class=\x22grid\x22>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<h3>üîó\x20Subscription\x20&\x20Config</h3>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22margin-bottom:15px\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22font-size:14px;color:var(--muted)\x22>Import\x20these\x20links\x20into\x20your\x20client\x20(V2RayNG,\x20Streisand,\x20etc).</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x22\x20onclick=\x22copyTxt(\x27'+g+'\x27)\x22>Copy\x20Link</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20ghost\x22\x20onclick=\x22showQR(\x27'+g+'\x27)\x22>Show\x20QR</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span>Protocol</span><span>VLESS\x20+\x20WS\x20+\x20TLS</span></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span>Port</span><span>443</span></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span>UUID</span><span\x20style=\x22font-family:monospace\x22>'+a['split']('-')[0x0]+'...</span></div>\x0a\x20\x20\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<h3>üåê\x20Network\x20Info</h3>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span>Proxy\x20IP</span><span\x20id=\x22p-ip\x22>'+j+'</span></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span>Location</span><span\x20id=\x22p-loc\x22>'+k['city']+',\x20'+k['country']+'</span></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span>Your\x20IP</span><span\x20id=\x22c-ip\x22>Detecting...</span></div>\x0a\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20<div\x20class=\x22card\x20hidden\x22\x20id=\x22qr-card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20<h3\x20style=\x22color:#000\x22>Scan\x20QR\x20Code</h3>\x0a\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22qr-display\x22></div>\x0a\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20ghost\x22\x20onclick=\x22document.getElementById(\x27qr-card\x27).classList.add(\x27hidden\x27)\x22\x20style=\x22width:100%;margin-top:10px;background:#ddd;color:#000\x22>Close</button>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20</div>\x0a\x20\x20<div\x20id=\x22toast\x22>Copied!</div>\x0a\x0a\x20\x20<script\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20//\x20---\x20CRITICAL\x20FIX:\x20DEFINE\x20HELPERS\x20GLOBALLY\x20FIRST\x20---\x0a\x20\x20\x20\x20function\x20formatBytes(bytes)\x20{\x0a\x20\x20\x20\x20\x20\x20if\x20(bytes\x20===\x200)\x20return\x20\x270\x20Bytes\x27;\x0a\x20\x20\x20\x20\x20\x20const\x20k\x20=\x201024;\x0a\x20\x20\x20\x20\x20\x20const\x20sizes\x20=\x20[\x27Bytes\x27,\x20\x27KB\x27,\x20\x27MB\x27,\x20\x27GB\x27,\x20\x27TB\x27];\x0a\x20\x20\x20\x20\x20\x20const\x20i\x20=\x20Math.floor(Math.log(bytes)\x20/\x20Math.log(k));\x0a\x20\x20\x20\x20\x20\x20return\x20parseFloat((bytes\x20/\x20Math.pow(k,\x20i)).toFixed(2))\x20+\x20\x27\x20\x27\x20+\x20sizes[i];\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20//\x20---\x20QR\x20CODE\x20LIBRARY\x20(Embedded\x20Minified)\x20---\x0a\x20\x20\x20\x20var\x20QRCode;!function(){function\x20a(a){this.mode=c.MODE_8BIT_BYTE,this.data=a,this.parsedData=[];for(var\x20b=[],d=0,e=this.data.length;d<e;d++){var\x20f=this.data.charCodeAt(d);f>65536?(b[0]=240|(1835008&f)>>>18,b[1]=128|(258048&f)>>>12,b[2]=128|(4032&f)>>>6,b[3]=128|63&f):f>2048?(b[0]=224|(61440&f)>>>12,b[1]=128|(4032&f)>>>6,b[2]=128|63&f):f>128?(b[0]=192|(1984&f)>>>6,b[1]=128|63&f):b[0]=f,this.parsedData.push(b),b=[]}this.parsedData=Array.prototype.concat.apply([],this.parsedData),this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function\x20b(a,b){this.typeNumber=a,this.errorCorrectLevel=b,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}var\x20c={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},d={L:1,M:0,Q:3,H:2},e={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7},f={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(a){for(var\x20b=a<<10;f.getBCHDigit(b)-f.getBCHDigit(f.G15)>=0;)b^=f.G15<<f.getBCHDigit(b)-f.getBCHDigit(f.G15);return(a<<10|b)^f.G15_MASK},getBCHTypeNumber:function(a){for(var\x20b=a<<12;f.getBCHDigit(b)-f.getBCHDigit(f.G18)>=0;)b^=f.G18<<f.getBCHDigit(b)-f.getBCHDigit(f.G18);return\x20a<<12|b},getBCHDigit:function(a){for(var\x20b=0;0!=a;)b++,a>>>=1;return\x20b},getPatternPosition:function(a){return\x20f.PATTERN_POSITION_TABLE[a-1]},getMask:function(a,b,c){switch(a){case\x20e.PATTERN000:return(b+c)%2==0;case\x20e.PATTERN001:return\x20b%2==0;case\x20e.PATTERN010:return\x20c%3==0;case\x20e.PATTERN011:return(b+c)%3==0;case\x20e.PATTERN100:return(Math.floor(b/2)+Math.floor(c/3))%2==0;case\x20e.PATTERN101:return\x20b*c%2+b*c%3==0;case\x20e.PATTERN110:return(b*c%2+b*c%3)%2==0;case\x20e.PATTERN111:return(b*c%3+(b+c)%2)%2==0;default:throw\x20new\x20Error(\x22bad\x20maskPattern:\x22+a)}},getErrorCorrectPolynomial:function(a){for(var\x20c=new\x20a([1],0),d=0;d<a;d++)c=c.multiply(new\x20a([1,f.gexp(d)],0));return\x20c},getLengthInBits:function(a,b){if(1<=b&&b<10)switch(a){case\x20c.MODE_NUMBER:return\x2010;case\x20c.MODE_ALPHA_NUM:return\x209;case\x20c.MODE_8BIT_BYTE:return\x208;case\x20c.MODE_KANJI:return\x208;default:throw\x20new\x20Error(\x22mode:\x22+a)}else\x20if(b<27)switch(a){case\x20c.MODE_NUMBER:return\x2012;case\x20c.MODE_ALPHA_NUM:return\x2011;case\x20c.MODE_8BIT_BYTE:return\x2016;case\x20c.MODE_KANJI:return\x2010;default:throw\x20new\x20Error(\x22mode:\x22+a)}else{if(!(b<41))throw\x20new\x20Error(\x22type:\x22+b);switch(a){case\x20c.MODE_NUMBER:return\x2014;case\x20c.MODE_ALPHA_NUM:return\x2013;case\x20c.MODE_8BIT_BYTE:return\x2016;case\x20c.MODE_KANJI:return\x2012;default:throw\x20new\x20Error(\x22mode:\x22+a)}}},gexp:function(a){for(;a<0;)a+=255;for(;a>=256;)a-=255;return\x20f.EXP_TABLE[a]},glog:function(a){if(a<1)throw\x20new\x20Error(\x22glog(\x22+a+\x22)\x22);return\x20f.LOG_TABLE[a]},getRSBlocks:function(a,b){switch(b){case\x20d.L:return\x20f.RS_BLOCK_TABLE[4*(a-1)+0];case\x20d.M:return\x20f.RS_BLOCK_TABLE[4*(a-1)+1];case\x20d.Q:return\x20f.RS_BLOCK_TABLE[4*(a-1)+2];case\x20d.H:return\x20f.RS_BLOCK_TABLE[4*(a-1)+3];default:throw\x20new\x20Error(\x22bad\x20rs\x20block\x20@\x20typeNumber:\x20\x22+a+\x22/errorCorrectLevel:\x20\x22+b)}},getBuffer:function(){return\x20this.modules}};f.EXP_TABLE=new\x20Array(256);for(var\x20g=0;g<8;g++)f.EXP_TABLE[g]=1<<g;for(var\x20g=8;g<256;g++)f.EXP_TABLE[g]=f.EXP_TABLE[g-4]^f.EXP_TABLE[g-5]^f.EXP_TABLE[g-6]^f.EXP_TABLE[g-8];f.LOG_TABLE=new\x20Array(256);for(var\x20g=0;g<255;g++)f.LOG_TABLE[f.EXP_TABLE[g]]=g;a.prototype={getLength:function(){return\x20this.parsedData.length},write:function(a){for(var\x20b=0,c=this.parsedData.length;b<c;b++)a.put(this.parsedData[b],8)}};b.prototype={isDark:function(a,b){if(a<0||this.moduleCount<=a||b<0||this.moduleCount<=b)throw\x20new\x20Error(a+\x22,\x22+b);return\x20this.modules[a][b]},getModuleCount:function(){return\x20this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(a,c){this.moduleCount=4*this.typeNumber+17,this.modules=new\x20Array(this.moduleCount);for(var\x20d=0;d<this.moduleCount;d++){this.modules[d]=new\x20Array(this.moduleCount);for(var\x20e=0;e<this.moduleCount;e++)this.modules[d][e]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(a,c),this.typeNumber>=7&&this.setupTypeNumber(a),null==this.dataCache&&(this.dataCache=b.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,c)},setupPositionProbePattern:function(a,b){for(var\x20c=-1;c<=7;c++)if(!(a+c<0||this.moduleCount<=a+c))for(var\x20d=-1;d<=7;d++)b+d<0||this.moduleCount<=b+d||(0<=c&&6>=c&&(0==d||6==d)||0<=d&&6>=d&&(0==c||6==c)||2<=c&&4>=c&&2<=d&&4>=d?this.modules[a+c][b+d]=!0:this.modules[a+c][b+d]=!1)},getBestMaskPattern:function(){for(var\x20a=0,c=0,d=0;d<8;d++){this.makeImpl(!0,d);var\x20e=f.getLostPoint(this);(0==d||a>e)&&(a=e,c=d)}return\x20c},createMovieClip:function(a,b,c){var\x20d=a.createEmptyMovieClip(b,c);this.make();for(var\x20e=0;e<this.modules.length;e++)for(var\x20f=e*1,g=0;g<this.modules[e].length;g++){var\x20h=g*1;this.modules[e][g]&&(d.beginFill(0,100),d.moveTo(h,f),d.lineTo(h+1,f),d.lineTo(h+1,f+1),d.lineTo(h,f+1),d.endFill())}return\x20d},setupTimingPattern:function(){for(var\x20a=8;a<this.moduleCount-8;a++)null==this.modules[a][6]&&(this.modules[a][6]=0==a%2);for(var\x20b=8;b<this.moduleCount-8;b++)null==this.modules[6][b]&&(this.modules[6][b]=0==b%2)},setupPositionAdjustPattern:function(){for(var\x20a=f.getPatternPosition(this.typeNumber),b=0;b<a.length;b++)for(var\x20c=0;c<a.length;c++){var\x20d=a[b],e=a[c];if(null==this.modules[d][e])for(var\x20g=-2;g<=2;g++)for(var\x20h=-2;h<=2;h++)this.modules[d+g][e+h]=-2==g||2==g||-2==h||2==h||0==g&&0==h}},setupTypeNumber:function(a){for(var\x20b=f.getBCHTypeNumber(this.typeNumber),c=0;c<18;c++){var\x20d=!a&&1==(b>>c&1);this.modules[Math.floor(c/3)][c%3+this.moduleCount-8-3]=d}for(var\x20c=0;c<18;c++){var\x20d=!a&&1==(b>>c&1);this.modules[c%3+this.moduleCount-8-3][Math.floor(c/3)]=d}},setupTypeInfo:function(a,b){for(var\x20c=this.errorCorrectLevel<<3|b,d=f.getBCHTypeInfo(c),e=0;e<15;e++){var\x20g=!a&&1==(d>>e&1);6>e?this.modules[e][8]=g:8>e?this.modules[e+1][8]=g:this.modules[this.moduleCount-15+e][8]=g}for(var\x20e=0;e<15;e++){var\x20g=!a&&1==(d>>e&1);8>e?this.modules[8][this.moduleCount-e-1]=g:9>e?this.modules[8][15-e-1+1]=g:this.modules[8][15-e-1]=g}this.modules[this.moduleCount-8][8]=!a},mapData:function(a,b){for(var\x20c=-1,d=this.moduleCount-1,e=7,g=0,h=this.moduleCount-1;h>0;h-=2)for(6==h&&h--;;){for(var\x20i=0;i<2;i++)if(null==this.modules[d][h-i]){var\x20j=!1;g<a.length&&(j=1==(a[g]>>>e&1)),f.getMask(b,d,h-i)&&(j=!j),this.modules[d][h-i]=j,e--,-1==e&&(g++,e=7)}if(d+=c,d<0||this.moduleCount<=d){d-=c,c=-c;break}}}};b.PAD0=236;b.PAD1=17;b.createData=function(c,d,e){for(var\x20g=f.getRSBlocks(c,d),h=new\x20b(c,d),i=0;i<e.length;i++){var\x20j=e[i];h.addData(j.mode,j.getLength(),j)}if(h.dataList.length>0){var\x20k=0;for(var\x20i=0;i<g.length;i++)k+=g[i].dataCount;if(h.dataList.length>k*8)throw\x20new\x20Error(\x22code\x20length\x20overflow.\x20(\x22+h.dataList.length+\x22>\x22+k*8+\x22)\x22);}return\x20h.dataCache};b.addData=function(a,c,d){var\x20e=new\x20a(c);this.dataList.push(e),this.dataCache=null};b.createBytes=function(a,b){for(var\x20c=0,d=0,e=0,g=new\x20Array(b.length),h=new\x20Array(b.length),i=0;i<b.length;i++){var\x20j=b[i].dataCount,k=b[i].totalCount-j;d=Math.max(d,j),e=Math.max(e,k),g[i]=new\x20Array(j);for(var\x20l=0;l<j;l++)g[i][l]=255&a.buffer[l+c];c+=j;var\x20m=f.getErrorCorrectPolynomial(k),n=(new\x20a(g[i],m.getLength()-1)).mod(m);h[i]=new\x20Array(m.getLength()-1);for(var\x20l=0;l<h[i].length;l++){var\x20o=l+n.getLength()-h[i].length;h[i][l]=o>=0?n.get(o):0}}for(var\x20p=0,q=0;q<b.length;q++)p+=b[q].totalCount;for(var\x20r=new\x20Array(p),s=0,l=0;l<d;l++)for(var\x20q=0;q<b.length;q++)l<g[q].length&&(r[s++]=g[q][l]);for(var\x20l=0;l<e;l++)for(var\x20q=0;q<b.length;q++)l<h[q].length&&(r[s++]=h[q][l]);return\x20r};QRCode=b}();\x0a\x0a\x20\x20\x20\x20//\x20---\x20CONFIG\x20&\x20STATE\x20---\x0a\x20\x20\x20\x20const\x20CFG\x20=\x20{\x0a\x20\x20\x20\x20\x20\x20uuid:\x20\x22'+a+'\x22,\x0a\x20\x20\x20\x20\x20\x20limit:\x20'+(f['traffic_limit']||'null')+',\x0a\x20\x20\x20\x20\x20\x20used:\x20'+(f['traffic_used']||0x0)+',\x0a\x20\x20\x20\x20\x20\x20expiry:\x20\x22'+(f['expiration_date']?f['expiration_date']+'T'+f['expiration_time']+'Z':'')+'\x22\x0a\x20\x20\x20\x20};\x0a\x0a\x20\x20\x20\x20//\x20---\x20UI\x20FUNCTIONS\x20---\x0a\x20\x20\x20\x20function\x20copyTxt(txt)\x20{\x0a\x20\x20\x20\x20\x20\x20navigator.clipboard.writeText(txt).then(()\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20t\x20=\x20document.getElementById(\x27toast\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20t.classList.add(\x27show\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20setTimeout(()\x20=>\x20t.classList.remove(\x27show\x27),\x202000);\x0a\x20\x20\x20\x20\x20\x20}).catch(()\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20ta\x20=\x20document.createElement(\x27textarea\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20ta.value\x20=\x20txt;\x20document.body.appendChild(ta);\x20ta.select();\x20document.execCommand(\x27copy\x27);\x20document.body.removeChild(ta);\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20t\x20=\x20document.getElementById(\x27toast\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20t.classList.add(\x27show\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20setTimeout(()\x20=>\x20t.classList.remove(\x27show\x27),\x202000);\x0a\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20function\x20showQR(txt)\x20{\x0a\x20\x20\x20\x20\x20\x20const\x20c\x20=\x20document.getElementById(\x27qr-card\x27);\x0a\x20\x20\x20\x20\x20\x20const\x20d\x20=\x20document.getElementById(\x27qr-display\x27);\x0a\x20\x20\x20\x20\x20\x20c.classList.remove(\x27hidden\x27);\x0a\x20\x20\x20\x20\x20\x20d.innerHTML\x20=\x20\x27\x27;\x0a\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20try\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20if(typeof\x20QRCode\x20!==\x20\x27undefined\x27)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20new\x20QRCode(d,\x20{\x20text:\x20txt,\x20width:\x20250,\x20height:\x20250\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x20else\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20throw\x20new\x20Error(\x27Lib\x20missing\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20}\x20catch(e)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20console.log(\x27QR\x20Lib\x20failed,\x20using\x20API\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20img\x20=\x20document.createElement(\x27img\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20img.src\x20=\x20\x27https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=\x27\x20+\x20encodeURIComponent(txt);\x0a\x20\x20\x20\x20\x20\x20\x20\x20d.appendChild(img);\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20function\x20updateTimer()\x20{\x0a\x20\x20\x20\x20\x20\x20const\x20el\x20=\x20document.getElementById(\x27expiry-countdown\x27);\x0a\x20\x20\x20\x20\x20\x20if\x20(!CFG.expiry)\x20{\x20el.innerText\x20=\x20\x27Unlimited\x27;\x20return;\x20}\x0a\x20\x20\x20\x20\x20\x20const\x20now\x20=\x20new\x20Date();\x0a\x20\x20\x20\x20\x20\x20const\x20exp\x20=\x20new\x20Date(CFG.expiry);\x0a\x20\x20\x20\x20\x20\x20const\x20diff\x20=\x20exp\x20-\x20now;\x0a\x0a\x20\x20\x20\x20\x20\x20if\x20(diff\x20<=\x200)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20el.innerText\x20=\x20\x27Expired\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20el.style.color\x20=\x20\x27var(--danger)\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27status-badge\x27).innerText\x20=\x20\x27Expired\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20const\x20d\x20=\x20Math.floor(diff\x20/\x20(1000\x20*\x2060\x20*\x2060\x20*\x2024));\x0a\x20\x20\x20\x20\x20\x20const\x20h\x20=\x20Math.floor((diff\x20/\x20(1000\x20*\x2060\x20*\x2060))\x20%\x2024);\x0a\x20\x20\x20\x20\x20\x20const\x20m\x20=\x20Math.floor((diff\x20/\x201000\x20/\x2060)\x20%\x2060);\x0a\x20\x20\x20\x20\x20\x20el.innerText\x20=\x20d\x20+\x20\x27d\x20\x27\x20+\x20h\x20+\x20\x27h\x20\x27\x20+\x20m\x20+\x20\x27m\x27;\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20async\x20function\x20fetchClientIP()\x20{\x0a\x20\x20\x20\x20\x20\x20try\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20r\x20=\x20await\x20fetch(\x27https://api.ipify.org?format=json\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20d\x20=\x20await\x20r.json();\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27c-ip\x27).innerText\x20=\x20d.ip;\x0a\x20\x20\x20\x20\x20\x20}\x20catch\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27c-ip\x27).innerText\x20=\x20\x27Failed\x27;\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20//\x20---\x20AUTO\x20REFRESH\x20LOGIC\x20(Corrected)\x20---\x0a\x20\x20\x20\x20async\x20function\x20refreshStats()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20try\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20r\x20=\x20await\x20fetch(\x27/api/user/\x27\x20+\x20CFG.uuid);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20if(!r.ok)\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20d\x20=\x20await\x20r.json();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20CFG.used\x20=\x20d.traffic_used;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20CFG.limit\x20=\x20d.traffic_limit;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27usage-display\x27).innerText\x20=\x20formatBytes(CFG.used);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20if(CFG.limit)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20pct\x20=\x20Math.min((CFG.used\x20/\x20CFG.limit)\x20*\x20100,\x20100);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27p-bar\x27).style.width\x20=\x20pct\x20+\x20\x27%\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27usage-text\x27).innerText\x20=\x20formatBytes(CFG.used);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20}\x20catch(e)\x20{\x20console.log(\x27Refresh\x20error\x27,\x20e);\x20}\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20//\x20Init\x0a\x20\x20\x20\x20(function()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27usage-display\x27).innerText\x20=\x20formatBytes(CFG.used);\x0a\x20\x20\x20\x20\x20\x20\x20if(CFG.limit)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20pct\x20=\x20Math.min((CFG.used\x20/\x20CFG.limit)\x20*\x20100,\x20100);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27p-bar\x27).style.width\x20=\x20pct\x20+\x20\x27%\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27usage-text\x27).innerText\x20=\x20formatBytes(CFG.used);\x0a\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20updateTimer();\x0a\x20\x20\x20\x20\x20\x20\x20setInterval(updateTimer,\x2060000);\x0a\x20\x20\x20\x20\x20\x20\x20setInterval(refreshStats,\x2030000);\x0a\x20\x20\x20\x20\x20\x20\x20fetchClientIP();\x0a\x20\x20\x20\x20})();\x0a\x20\x20</script>\x0a</body>\x0a</html>',m=generateNonce(),n=new Headers({'Content-Type':'text/html;charset=utf-8'});return addSecurityHeaders(n,m,{'img':'data:\x20https://api.qrserver.com'}),new Response(l['replace'](/CSP_NONCE_PLACEHOLDER/g,m),{'headers':n});}async function handleAdminRequest(a,b,c,d,f){const g=new URL(a['url']),h=g['pathname']['substring'](f['length']+0x2),i=new Headers({'Content-Type':'text/html'}),j=generateNonce();addSecurityHeaders(i,j);const k=async()=>{const m=a['headers']['get']('Cookie')?.['match'](/admin_session=([^;]+)/)?.[0x1];if(!m)return null;return await kvGet(b['DB'],'session:'+m);},l=await k();if(h==='login'&&a['method']==='POST'){const m=await a['formData'](),n=m['get']('password'),o=m['get']('totp'),p=await hashSHA256(n);let q=timingSafeEqual(p,d['adminPasswordHash']);q&&d['adminTOTPSecret']&&(q=await validateTOTP(d['adminTOTPSecret'],o));if(q){const r=crypto['randomUUID']();return c['waitUntil'](kvPut(b['DB'],'session:'+r,'true',{'expirationTtl':0x15180})),i['set']('Set-Cookie','admin_session='+r+';\x20HttpOnly;\x20Secure;\x20SameSite=Strict;\x20Path=/'),i['set']('Location','/'+f+'/'),new Response(null,{'status':0x12e,'headers':i});}else return new Response('Authentication\x20Failed',{'status':0x191,'headers':i});}if(h==='logout'){const s=a['headers']['get']('Cookie')?.['match'](/admin_session=([^;]+)/)?.[0x1];if(s)c['waitUntil'](kvDelete(b['DB'],'session:'+s));return i['set']('Set-Cookie','admin_session=;\x20Max-Age=0;\x20HttpOnly;\x20Secure;\x20SameSite=Strict;\x20Path=/'),i['set']('Location','/'+f+'/login'),new Response(null,{'status':0x12e,'headers':i});}if(!l){if(h!=='login')return i['set']('Location','/'+f+'/login'),new Response(null,{'status':0x12e,'headers':i});return new Response(adminLoginHTML['replace'](/CSP_NONCE_PLACEHOLDER/g,j)['replace']('ADMIN_PATH_PLACEHOLDER','/'+f+'/login'),{'headers':i});}if(h['startsWith']('api/user')){const t=h['split']('/')['pop']();if(a['method']==='POST')try{const u=await a['json'](),{uuid:v,traffic_limit:w,expiration_date:x,expiration_time:y}=u;if(!isValidUUID(v)||!b['DB'])return new Response('Invalid\x20Data\x20or\x20DB\x20not\x20available',{'status':0x190});const z=await getUserData(b,v,c);return z?await b['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_limit\x20=\x20?,\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](w,x,y,v)['run']():await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20traffic_limit,\x20traffic_used,\x20expiration_date,\x20expiration_time)\x20VALUES\x20(?,\x20?,\x200,\x20?,\x20?)')['bind'](v,w,x,y)['run'](),c['waitUntil'](kvDelete(b['DB'],'user:'+v)),new Response('User\x20saved',{'status':0xc8});}catch(A){return new Response('Error\x20saving\x20user:\x20'+A['message'],{'status':0x1f4});}if(a['method']==='DELETE'&&isValidUUID(t))try{return await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](t)['run'](),c['waitUntil'](kvDelete(b['DB'],'user:'+t)),new Response('User\x20deleted',{'status':0xc8});}catch(B){return new Response('Error\x20deleting\x20user',{'status':0x1f4});}}if(h===''||h==='/'){let C=[];try{if(b['DB']){const {results:D}=await b['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20ORDER\x20BY\x20traffic_used\x20DESC')['all']();C=D['map'](E=>({...E,'traffic_limit':E['traffic_limit'],'traffic_used':E['traffic_used']}));}}catch(E){C=[],console['error']('D1\x20Read\x20Error:',E['message']);}return new Response(adminPanelHTML(f,C)['replace'](/CSP_NONCE_PLACEHOLDER/g,j),{'headers':i});}return new Response('Admin\x20Resource\x20Not\x20Found',{'status':0x194});}async function ProtocolOverWSHandler(a,b,c,d){const e=new WebSocketPair(),[f,g]=Object['values'](e);g['accept']();let h='',i='',j=0x0,k='';const l=(o,p)=>console['log']('['+h+':'+i+']\x20'+o,p||''),m=MakeReadableWebSocketStream(g,a['headers']['get']('Sec-WebSocket-Protocol')||'',l);let n={'value':null};return m['pipeTo'](new WritableStream({async 'write'(o,p){j+=o['byteLength'];if(n['value']){const B=n['value']['writable']['getWriter']();await B['write'](o),B['releaseLock']();return;}const {user:q,hasError:r,message:s,addressRemote:t,portRemote:u,rawDataIndex:v,ProtocolVersion:w,isUDP:x,addressType:y}=await ProcessProtocolHeader(o,c,d);if(r||!q||isExpired(q['expiration_date'],q['expiration_time'])){p['error'](new Error(s||'Auth\x20failed'));return;}j>0x0&&(d['waitUntil'](updateUsage(c,q['uuid'],j,d)),j=0x0);const z=new Uint8Array([w[0x0],0x0]),A=o['slice'](v);if(x){u===0x35?await handleUDP(g,z,A):p['error'](new Error('UDP\x20blocked'));return;}await handleTCP(n,y,t,u,A,g,z,l,b);},'close'(){l('Stream\x20closed');},'abort'(o){l('Stream\x20aborted',o);}}))['catch'](o=>safeCloseWebSocket(g)),new Response(null,{'status':0x65,'webSocket':f});}async function handleUDP(a,b,c){try{const d=await fetch('https://1.1.1.1/dns-query',{'method':'POST','headers':{'content-type':'application/dns-message'},'body':c}),f=await d['arrayBuffer'](),g=f['byteLength'],h=new Uint8Array([g>>0x8&0xff,g&0xff]),i=await new Blob([b,h,f])['arrayBuffer']();a['send'](i);}catch(j){}}async function handleTCP(a,b,c,d,e,f,g,h,i){const j=connect({'hostname':c,'port':d});a['value']=j;const k=j['writable']['getWriter']();await k['write'](e),k['releaseLock'](),await j['readable']['pipeTo'](new WritableStream({async 'write'(l){if(f['readyState']===0x1){const m=g?await new Blob([g,l])['arrayBuffer']():l;f['send'](m),g=null;}}}));}async function ProcessProtocolHeader(a,b,c){if(a['byteLength']<0x18)return{'hasError':!![],'message':'Too\x20short'};const d=new DataView(a),e=d['getUint8'](0x0),f=stringify(new Uint8Array(a['slice'](0x1,0x11))),g=await getUserData(b,f,c);if(!g)return{'hasError':!![],'message':'User\x20not\x20found'};const h=d['getUint8'](0x11),i=d['getUint8'](0x12+h),j=d['getUint16'](0x13+h),k=d['getUint8'](0x15+h);let l='',m=0x16+h;if(k===0x1)l=new Uint8Array(a['slice'](m,m+0x4))['join']('.'),m+=0x4;else{if(k===0x2){const n=d['getUint8'](m);l=new TextDecoder()['decode'](a['slice'](m+0x1,m+0x1+n)),m+=0x1+n;}else k===0x3&&(l=Array['from']({'length':0x8},(o,p)=>d['getUint16'](m+p*0x2)['toString'](0x10))['join'](':'),m+=0x10);}return{'user':g,'hasError':![],'addressRemote':l,'portRemote':j,'rawDataIndex':m,'ProtocolVersion':new Uint8Array([e]),'isUDP':i===0x2,'addressType':k};}function MakeReadableWebSocketStream(a,b,c){return new ReadableStream({'start'(d){a['addEventListener']('message',f=>d['enqueue'](f['data'])),a['addEventListener']('close',()=>{safeCloseWebSocket(a),d['close']();}),a['addEventListener']('error',f=>d['error'](f));if(b)try{const f=atob(b['replace'](/-/g,'+')['replace'](/_/g,'/')),g=new Uint8Array(f['length']);for(let h=0x0;h<f['length'];h++)g[h]=f['charCodeAt'](h);d['enqueue'](g['buffer']);}catch(j){}},'cancel'(){safeCloseWebSocket(a);}});}function safeCloseWebSocket(a){try{if(a['readyState']===0x1||a['readyState']===0x2)a['close']();}catch(b){}}export default{async 'fetch'(a,b,c){let d;try{d=await Config['fromEnv'](b);}catch(i){return new Response(i['message'],{'status':0x1f4});}const e=new URL(a['url']),f=a['headers']['get']('CF-Connecting-IP');if(a['headers']['get']('Upgrade')==='websocket')return ProtocolOverWSHandler(a,d,b,c);const g=b['ADMIN_PATH_PREFIX']||'admin';if(e['pathname']['startsWith']('/'+g+'/'))return handleAdminRequest(a,b,c,d,g);if(e['pathname']['startsWith']('/api/user/')){const j=e['pathname']['split']('/')['pop']();if(!isValidUUID(j))return new Response('Invalid\x20UUID',{'status':0x190});const k=await getUserData(b,j,c);if(!k)return new Response('Unauthorized',{'status':0x193});return new Response(JSON['stringify'](k),{'headers':{'Content-Type':'application/json'}});}if(e['pathname']['startsWith']('/xray/')||e['pathname']['startsWith']('/sb/')){const l=e['pathname']['split']('/'),m=l[0x2];if(!isValidUUID(m))return new Response('Invalid',{'status':0x190});const n=await getUserData(b,m,c);if(!n||isExpired(n['expiration_date'],n['expiration_time']))return new Response('Expired/Invalid',{'status':0x193});return handleIpSubscription(l[0x1],m,e['hostname']);}const h=e['pathname']['slice'](0x1);if(isValidUUID(h)){const o=await getUserData(b,h,c);if(!o)return new Response('User\x20Not\x20Found',{'status':0x194});return handleUserPanel(h,e['hostname'],d['proxyAddress'],o);}return new Response('Not\x20Found',{'status':0x194});}};